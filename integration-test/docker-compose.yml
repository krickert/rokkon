version: '3.8'

services:
  consul:
    image: hashicorp/consul:1.21.1
    container_name: rokkon-consul
    command: "consul agent -dev -ui -client=0.0.0.0 -bind=0.0.0.0 -data-dir=/consul/data"
    ports:
      - "8500:8500"  # Temporarily exposed for seeding configuration
    networks:
      - rokkon-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  engine:
    image: rokkon/engine:latest
    container_name: rokkon-engine
    depends_on:
      consul:
        condition: service_healthy
    environment:
      # Set Quarkus profile
      QUARKUS_PROFILE: "prod"
      
      # Quarkus Configuration - Override application.yml values
      QUARKUS_CONSUL_CONFIG_AGENT_HOST_PORT: "consul:8500"
      CONSUL_HOST: "consul"
      CONSUL_PORT: 8500
      
      # Vertx Consul client configuration
      QUARKUS_VERTX_CONSUL_CLIENT_HOST: "consul"
      QUARKUS_VERTX_CONSUL_CLIENT_PORT: 8500
      
      # Override HTTP and gRPC settings
      QUARKUS_HTTP_HOST: "0.0.0.0"
      QUARKUS_HTTP_PORT: 8080
      QUARKUS_GRPC_SERVER_HOST: "0.0.0.0"
      QUARKUS_GRPC_SERVER_PORT: 48081
      
      # Rokkon Configuration
      ROKKON_ENGINE_NAME: "rokkon-engine"
      ROKKON_ENGINE_VERSION: "1.0.0-SNAPSHOT"
      
      # Java options for container
      JAVA_OPTS: "-Dquarkus.http.host=0.0.0.0 -Djava.util.logging.manager=org.jboss.logmanager.LogManager"
    ports:
      - "18080:8080"  # HTTP API & Dashboard on non-conflicting port
      - "48081:48081"  # gRPC port
    networks:
      - rokkon-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/q/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  test-module:
    image: rokkon/test-module:latest
    container_name: rokkon-test-module
    # depends_on:
    #   engine:
    #     condition: service_healthy
    environment:
      # Module configuration
      MODULE_HOST: "0.0.0.0"
      MODULE_PORT: 9090
      
      # Engine connection for registration
      ENGINE_HOST: "engine"
      ENGINE_PORT: 48081
      
      # Consul connection (optional)
      CONSUL_HOST: "consul"
      CONSUL_PORT: 8500
      
      # Registration settings
      HEALTH_CHECK: "true"
      MAX_RETRIES: 5
      STARTUP_TIMEOUT: 60
      CHECK_INTERVAL: 5
      
      # Java options
      JAVA_OPTS: "-Dquarkus.http.host=0.0.0.0"
    # No ports exposed - internal only
    networks:
      - rokkon-network

networks:
  rokkon-network:
    driver: bridge
    name: rokkon-network