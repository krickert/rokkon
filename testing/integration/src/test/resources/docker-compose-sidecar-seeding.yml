version: '3.8'

services:
  # Consul server
  consul-server:
    image: hashicorp/consul:latest
    command: agent -dev -ui -client=0.0.0.0
    ports:
      - "8500:8500"
    networks:
      - test-net
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 5s

  # Engine with sidecar that seeds config
  pipeline-engine:
    image: rokkon/engine:latest
    environment:
      - QUARKUS_HTTP_PORT=38082
      - QUARKUS_GRPC_SERVER_PORT=48082
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_CONSUL_HOST=127.0.0.1  # Connect to sidecar
      - QUARKUS_CONSUL_PORT=8500
      - QUARKUS_CONSUL_CONFIG_ENABLED=true
      - QUARKUS_CONSUL_CONFIG_AGENT_HOST_PORT=127.0.0.1:8500
      - QUARKUS_PROFILE=prod
      - CLUSTER_NAME=test-cluster
      - ROKKON_CLUSTER_NAME=test-cluster
      - ROKKON_ENGINE_NAME=test-engine
    ports:
      - "38082:38082"
      - "48082:48082"
    networks:
      - test-net
    depends_on:
      consul-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:38082/q/health"]
      interval: 10s

  # Sidecar that seeds config and provides local agent
  engine-sidecar:
    image: rokkon/seed-engine-consul-config:latest
    network_mode: "service:pipeline-engine"
    volumes:
      - ./seed-data.json:/seed-data.json:ro
      - ./empty.properties:/empty.properties:ro
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "echo 'Starting sidecar with seeding...' && \
      # First run consul agent in background
      consul agent -data-dir=/consul/data -retry-join=consul-server -bind=127.0.0.1 & \
      CONSUL_PID=$$! && \
      # Wait for agent to be ready
      sleep 5 && \
      # Seed configs using the seeder
      echo 'Seeding config/application...' && \
      java -jar /deployments/quarkus-run.jar -h 127.0.0.1 -p 8500 --key config/application --import /seed-data.json --force && \
      echo 'Seeding config/prod...' && \
      java -jar /deployments/quarkus-run.jar -h 127.0.0.1 -p 8500 --key config/prod --config /empty.properties --force && \
      echo 'Seeding complete, keeping sidecar running...' && \
      # Keep the sidecar running
      wait $$CONSUL_PID"

networks:
  test-net:
    driver: bridge