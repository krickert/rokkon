version: '3.8'

services:
  # Consul server for service discovery
  consul-server:
    image: hashicorp/consul:latest
    command: agent -dev -ui -client=0.0.0.0 -bind=0.0.0.0
    expose:
      - "8500"
      - "8600/udp"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Pipeline Engine - without consul config
  pipeline-engine:
    image: rokkon/engine:latest
    environment:
      - QUARKUS_HTTP_PORT=38082
      - QUARKUS_GRPC_SERVER_PORT=48082
      - QUARKUS_CONSUL_HOST=consul-server
      - QUARKUS_CONSUL_PORT=8500
      - QUARKUS_CONSUL_CONFIG_ENABLED=false  # Disable consul config
      - QUARKUS_CONSUL_ENABLED=true  # Keep consul enabled for service discovery
      - CLUSTER_NAME=test-cluster
      - ROKKON_CLUSTER_NAME=test-cluster
      - ROKKON_ENGINE_NAME=test-engine
      # Provide config directly via env vars
      - ROKKON_MODULES_WHITELIST=echo,test,chunker,parser,embedder
      # Enable debug mode
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
    expose:
      - "38082"  # HTTP port
      - "48082"  # gRPC port
      - "5005"   # Debug port
    depends_on:
      consul-server:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:38082/q/health"]
      interval: 10s
      timeout: 5s
      retries: 15

networks:
  test-network:
    name: test-pipeline-network
    driver: bridge