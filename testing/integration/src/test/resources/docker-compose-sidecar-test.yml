version: '3.8'

services:
  # Step 0: Just test that sidecars can connect to Consul
  
  consul-server:
    image: hashicorp/consul:latest
    command: agent -dev -ui -client=0.0.0.0
    ports:
      - "8500:8500"
    networks:
      - test-net

  # Simple test app (nginx)
  test-app:
    image: nginx:alpine
    ports:
      - "8080:80"
    networks:
      - test-net

  # Sidecar for test app
  test-app-sidecar:
    image: hashicorp/consul:latest
    network_mode: "service:test-app"
    command: >
      consul agent 
      -data-dir=/consul/data
      -retry-join=consul-server
      -bind=127.0.0.1

networks:
  test-net:
    driver: bridge