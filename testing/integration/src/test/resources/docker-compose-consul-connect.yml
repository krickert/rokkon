version: '3.8'

services:
  # Consul server for service discovery and configuration
  consul-server:
    image: hashicorp/consul:latest
    command: >
      agent -dev -ui 
      -client=0.0.0.0 
      -bind=0.0.0.0
      -config-dir=/consul/config
    expose:
      - "8500"
      - "8501"
      - "8502"
      - "8600/udp"
    volumes:
      - ./consul-connect-config.json:/consul/config/connect.json:ro
    networks:
      - service-mesh
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Seed application config
  consul-seeder-app:
    image: rokkon/seed-engine-consul-config:latest
    depends_on:
      consul-server:
        condition: service_healthy
    networks:
      - service-mesh
    volumes:
      - ./seed-data.json:/seed-data.json:ro
    command: [
      "-h", "consul-server",
      "-p", "8500",
      "--key", "config/application",
      "--import", "/seed-data.json",
      "--force"
    ]

  # Seed cluster config
  consul-seeder-cluster:
    image: rokkon/seed-engine-consul-config:latest
    depends_on:
      consul-seeder-app:
        condition: service_completed_successfully
    networks:
      - service-mesh
    volumes:
      - ./test-consul-config.properties:/config.properties:ro
    command: [
      "-h", "consul-server",
      "-p", "8500",
      "--key", "pipeline/test-cluster/config",
      "--config", "/config.properties",
      "--force"
    ]

  # Register engine service in Consul
  consul-register-engine:
    image: hashicorp/consul:latest
    depends_on:
      consul-seeder-cluster:
        condition: service_completed_successfully
    networks:
      - service-mesh
    command: >
      sh -c "
      consul services register -name=pipeline-engine -port=38082 -address=pipeline-engine &&
      consul services register -name=pipeline-engine-grpc -port=48082 -address=pipeline-engine
      "
    environment:
      - CONSUL_HTTP_ADDR=consul-server:8500

  # Pipeline Engine
  pipeline-engine:
    image: rokkon/engine:latest
    environment:
      - QUARKUS_HTTP_PORT=38082
      - QUARKUS_GRPC_SERVER_PORT=48082
      - QUARKUS_CONSUL_HOST=localhost  # Sidecar will be on localhost
      - QUARKUS_CONSUL_PORT=8500
      - QUARKUS_CONSUL_CONFIG_ENABLED=true
      - QUARKUS_PROFILE=test
      - CLUSTER_NAME=test-cluster
      - ROKKON_CLUSTER_NAME=test-cluster
      - ROKKON_ENGINE_NAME=test-engine
      # Enable debug mode
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
    expose:
      - "38082"  # HTTP port
      - "48082"  # gRPC port  
      - "5005"   # Debug port
    depends_on:
      consul-register-engine:
        condition: service_completed_successfully
    networks:
      - service-mesh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:38082/q/health"]
      interval: 10s
      timeout: 5s
      retries: 15

  # Engine's Consul Connect sidecar
  engine-sidecar:
    image: hashicorp/consul:latest
    depends_on:
      pipeline-engine:
        condition: service_started
    network_mode: "service:pipeline-engine"
    command: >
      consul connect proxy 
      -sidecar-for pipeline-engine
      -admin-bind 127.0.0.1:19001
    environment:
      - CONSUL_HTTP_ADDR=consul-server:8500

  # Echo Module  
  echo-module:
    image: rokkon/echo-module:1.0.0-SNAPSHOT
    environment:
      - QUARKUS_HTTP_PORT=39091
      - QUARKUS_GRPC_SERVER_PORT=49091
      - MODULE_NAME=echo
      - MODULE_VERSION=1.0.0
      - ENGINE_HOST=localhost  # Via sidecar
      - ENGINE_GRPC_PORT=48082
      # Enable debug mode
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5006
    expose:
      - "39091"  # HTTP
      - "49091"  # gRPC
      - "5006"   # Debug port
    depends_on:
      pipeline-engine:
        condition: service_healthy
    networks:
      - service-mesh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:39091/q/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Echo module's Consul Connect sidecar
  echo-sidecar:
    image: hashicorp/consul:latest
    depends_on:
      echo-module:
        condition: service_started
    network_mode: "service:echo-module"
    command: >
      consul connect proxy
      -sidecar-for echo
      -admin-bind 127.0.0.1:19002
    environment:
      - CONSUL_HTTP_ADDR=consul-server:8500

  # Test Module
  test-module:
    image: rokkon/test-module:1.0.0-SNAPSHOT
    environment:
      - QUARKUS_HTTP_PORT=39092
      - QUARKUS_GRPC_SERVER_PORT=49092
      - MODULE_NAME=test
      - MODULE_VERSION=1.0.0
      - ENGINE_HOST=localhost  # Via sidecar
      - ENGINE_GRPC_PORT=48082
      # Enable debug mode
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5007
    expose:
      - "39092"  # HTTP
      - "49092"  # gRPC
      - "5007"   # Debug port
    depends_on:
      pipeline-engine:
        condition: service_healthy
    networks:
      - service-mesh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:39092/q/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Test module's Consul Connect sidecar
  test-sidecar:
    image: hashicorp/consul:latest
    depends_on:
      test-module:
        condition: service_started
    network_mode: "service:test-module"
    command: >
      consul connect proxy
      -sidecar-for test
      -admin-bind 127.0.0.1:19003
    environment:
      - CONSUL_HTTP_ADDR=consul-server:8500

networks:
  service-mesh:
    name: consul-service-mesh
    driver: bridge