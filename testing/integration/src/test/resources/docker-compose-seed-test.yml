version: '3.8'

services:
  # Consul server for service discovery and configuration
  consul-server:
    image: hashicorp/consul:latest
    command: agent -dev -ui -client=0.0.0.0 -bind=0.0.0.0
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Seed application config
  consul-seeder-app:
    image: rokkon/seed-engine-consul-config:latest
    depends_on:
      consul-server:
        condition: service_healthy
    networks:
      - test-network
    volumes:
      - ./seed-data.json:/seed-data.json:ro
    command: [
      "-h", "consul-server",
      "-p", "8500",
      "--key", "config/application",
      "--import", "/seed-data.json",
      "--force"
    ]

  # Verify what was actually seeded
  consul-verify:
    image: hashicorp/consul:latest
    depends_on:
      consul-seeder-app:
        condition: service_completed_successfully
    networks:
      - test-network
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "set -e; \
      echo '=== Verifying Consul configs ==='; \
      export CONSUL_HTTP_ADDR=consul-server:8500; \
      echo 'Waiting for Consul to stabilize...'; \
      sleep 5; \
      echo 'Checking config/application:'; \
      consul kv get config/application || (echo 'ERROR: Application config not found!' && exit 1); \
      echo ''; \
      echo 'Listing all keys:'; \
      consul kv get -recurse || echo 'No keys found'; \
      echo '=== Verification complete ==='"

networks:
  test-network:
    name: test-pipeline-network
    driver: bridge