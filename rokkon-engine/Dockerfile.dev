# Development Dockerfile for Quarkus dev mode
FROM registry.access.redhat.com/ubi8/openjdk-21:1.20

USER root

# Install required tools
RUN microdnf install -y findutils curl && \
    microdnf clean all

# Set up gradle user and permissions
RUN useradd -m -u 1000 gradle && \
    mkdir -p /home/gradle/.gradle && \
    chown -R gradle:gradle /home/gradle

USER gradle

# Set working directory
WORKDIR /app

# Copy gradle wrapper
COPY --chown=gradle:gradle gradlew /app/
COPY --chown=gradle:gradle gradle /app/gradle

# Copy build files
COPY --chown=gradle:gradle settings.gradle.kts /app/
COPY --chown=gradle:gradle build.gradle.kts /app/
COPY --chown=gradle:gradle gradle.properties /app/

# Copy project structure
COPY --chown=gradle:gradle rokkon-protobuf /app/rokkon-protobuf
COPY --chown=gradle:gradle rokkon-commons /app/rokkon-commons
COPY --chown=gradle:gradle engine /app/engine
COPY --chown=gradle:gradle test-utilities /app/test-utilities
COPY --chown=gradle:gradle rokkon-engine /app/rokkon-engine
COPY --chown=gradle:gradle modules /app/modules

# Expose ports
EXPOSE 8080 5005 49000

# Set environment variables for Consul
ENV CONSUL_HOST=consul
ENV CONSUL_PORT=8500
ENV QUARKUS_PROFILE=dev

# Enable remote debugging
ENV JAVA_ENABLE_DEBUG=true

# Run Quarkus in dev mode
CMD ["./gradlew", ":rokkon-engine:quarkusDev", "-Dquarkus.http.host=0.0.0.0"]